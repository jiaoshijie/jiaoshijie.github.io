<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>C 语言函数调用和VLA和alloca栈的变化探讨 | Jsj's Blog</title>
<meta name=keywords content="c"><meta name=description content="NOTE: 以下讨论使用的平台为 x86-64，使用的编译器为 gcc，以下提供的伪汇编码
采用 intel 格式。
文章中提到的代码，可以在 Code 找到。
一些重要的寄存器和指令
函数调用过程中，比较重要的寄存器主要有三个 rip rbp rsp。

rip 寄存器存放的为下一条要执行指令的地址，Instruction Pointer。
rbp 为基寄存器，存放的为前一个 rbp 的值，Base Pointer。
rsp 为栈寄存器，一直指向函数调用栈的底部，Stack Pointer。

比较重要的指令有 call push pop leave ret。
call addr 指令会首先将 call 返回之后要执行的地址压入栈中(返回地址)，设置 rip
的值为 addr，然后跳转的这个位置去执行，大致可以等效于一下指令。
# 假设当执行到 call 指令时 CPU 就会自动设置 rip 寄存器为下一条要执行的指令
push rip
mov rip, addr
# 按理设置了 rip 寄存器，CPU 就会去执行 rip 地址的指令，这里写 jmp 只是想要更清晰的表示 call 的流程
jmp addr
push rbp 指令会将 rsp 寄存器下移一个 word 的长度，rbp 中的内容移动到 rsp
寄存器所指向的地址中。"><meta name=author content="Jiao shijie"><link rel=canonical href=https://jiaoshijie.github.io/posts/function_call_and_vla_and_alloca/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.611cf8c8c671ee20d7166886b78e57ad24c8123fb1dc0fde4edee77b5f66d2e2.css integrity="sha256-YRz4yMZx7iDXFmiGt45XrSTIEj+x3A/eTt7ne19m0uI=" rel="preload stylesheet" as=style><link rel=icon href=https://jiaoshijie.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jiaoshijie.github.io/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://jiaoshijie.github.io/favicon.ico><link rel=apple-touch-icon href=https://jiaoshijie.github.io/favicon.ico><link rel=mask-icon href=https://jiaoshijie.github.io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://jiaoshijie.github.io/posts/function_call_and_vla_and_alloca/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="C 语言函数调用和VLA和alloca栈的变化探讨"><meta property="og:description" content="NOTE: 以下讨论使用的平台为 x86-64，使用的编译器为 gcc，以下提供的伪汇编码
采用 intel 格式。
文章中提到的代码，可以在 Code 找到。
一些重要的寄存器和指令
函数调用过程中，比较重要的寄存器主要有三个 rip rbp rsp。

rip 寄存器存放的为下一条要执行指令的地址，Instruction Pointer。
rbp 为基寄存器，存放的为前一个 rbp 的值，Base Pointer。
rsp 为栈寄存器，一直指向函数调用栈的底部，Stack Pointer。

比较重要的指令有 call push pop leave ret。
call addr 指令会首先将 call 返回之后要执行的地址压入栈中(返回地址)，设置 rip
的值为 addr，然后跳转的这个位置去执行，大致可以等效于一下指令。
# 假设当执行到 call 指令时 CPU 就会自动设置 rip 寄存器为下一条要执行的指令
push rip
mov rip, addr
# 按理设置了 rip 寄存器，CPU 就会去执行 rip 地址的指令，这里写 jmp 只是想要更清晰的表示 call 的流程
jmp addr
push rbp 指令会将 rsp 寄存器下移一个 word 的长度，rbp 中的内容移动到 rsp
寄存器所指向的地址中。"><meta property="og:type" content="article"><meta property="og:url" content="https://jiaoshijie.github.io/posts/function_call_and_vla_and_alloca/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-17T11:36:45+08:00"><meta property="article:modified_time" content="2024-04-17T11:36:45+08:00"><meta property="og:site_name" content="Jsj's Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="C 语言函数调用和VLA和alloca栈的变化探讨"><meta name=twitter:description content="NOTE: 以下讨论使用的平台为 x86-64，使用的编译器为 gcc，以下提供的伪汇编码
采用 intel 格式。
文章中提到的代码，可以在 Code 找到。
一些重要的寄存器和指令
函数调用过程中，比较重要的寄存器主要有三个 rip rbp rsp。

rip 寄存器存放的为下一条要执行指令的地址，Instruction Pointer。
rbp 为基寄存器，存放的为前一个 rbp 的值，Base Pointer。
rsp 为栈寄存器，一直指向函数调用栈的底部，Stack Pointer。

比较重要的指令有 call push pop leave ret。
call addr 指令会首先将 call 返回之后要执行的地址压入栈中(返回地址)，设置 rip
的值为 addr，然后跳转的这个位置去执行，大致可以等效于一下指令。
# 假设当执行到 call 指令时 CPU 就会自动设置 rip 寄存器为下一条要执行的指令
push rip
mov rip, addr
# 按理设置了 rip 寄存器，CPU 就会去执行 rip 地址的指令，这里写 jmp 只是想要更清晰的表示 call 的流程
jmp addr
push rbp 指令会将 rsp 寄存器下移一个 word 的长度，rbp 中的内容移动到 rsp
寄存器所指向的地址中。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://jiaoshijie.github.io/posts/"},{"@type":"ListItem","position":2,"name":"C 语言函数调用和VLA和alloca栈的变化探讨","item":"https://jiaoshijie.github.io/posts/function_call_and_vla_and_alloca/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"C 语言函数调用和VLA和alloca栈的变化探讨","name":"C 语言函数调用和VLA和alloca栈的变化探讨","description":"NOTE: 以下讨论使用的平台为 x86-64，使用的编译器为 gcc，以下提供的伪汇编码 采用 intel 格式。\n文章中提到的代码，可以在 Code 找到。\n一些重要的寄存器和指令 函数调用过程中，比较重要的寄存器主要有三个 rip rbp rsp。\nrip 寄存器存放的为下一条要执行指令的地址，Instruction Pointer。 rbp 为基寄存器，存放的为前一个 rbp 的值，Base Pointer。 rsp 为栈寄存器，一直指向函数调用栈的底部，Stack Pointer。 比较重要的指令有 call push pop leave ret。\ncall addr 指令会首先将 call 返回之后要执行的地址压入栈中(返回地址)，设置 rip 的值为 addr，然后跳转的这个位置去执行，大致可以等效于一下指令。\n# 假设当执行到 call 指令时 CPU 就会自动设置 rip 寄存器为下一条要执行的指令 push rip mov rip, addr # 按理设置了 rip 寄存器，CPU 就会去执行 rip 地址的指令，这里写 jmp 只是想要更清晰的表示 call 的流程 jmp addr push rbp 指令会将 rsp 寄存器下移一个 word 的长度，rbp 中的内容移动到 rsp 寄存器所指向的地址中。\n","keywords":["c"],"articleBody":"NOTE: 以下讨论使用的平台为 x86-64，使用的编译器为 gcc，以下提供的伪汇编码 采用 intel 格式。\n文章中提到的代码，可以在 Code 找到。\n一些重要的寄存器和指令 函数调用过程中，比较重要的寄存器主要有三个 rip rbp rsp。\nrip 寄存器存放的为下一条要执行指令的地址，Instruction Pointer。 rbp 为基寄存器，存放的为前一个 rbp 的值，Base Pointer。 rsp 为栈寄存器，一直指向函数调用栈的底部，Stack Pointer。 比较重要的指令有 call push pop leave ret。\ncall addr 指令会首先将 call 返回之后要执行的地址压入栈中(返回地址)，设置 rip 的值为 addr，然后跳转的这个位置去执行，大致可以等效于一下指令。\n# 假设当执行到 call 指令时 CPU 就会自动设置 rip 寄存器为下一条要执行的指令 push rip mov rip, addr # 按理设置了 rip 寄存器，CPU 就会去执行 rip 地址的指令，这里写 jmp 只是想要更清晰的表示 call 的流程 jmp addr push rbp 指令会将 rsp 寄存器下移一个 word 的长度，rbp 中的内容移动到 rsp 寄存器所指向的地址中。\nsub rsp, 0x8 mov QWORD PTR [rsp], rbp pop rbp 指令会将当前 rsp 寄存器所指向地址中的内容移动到 rbp 寄存器中，并将 rsp 寄存器上移一个 word 的长度。\nmov rbp, QWORD PTR [rsp] add rsp, 0x8 leave 指令会将 rsp 寄存器指向 rbp 当前指向的位置(这个位置存储的为前一个 rbp 的内容)，然后将 rbp 寄存器的内容设置为 前一个 rbp 的位置。\nmov rsp, rbp pop rbp ret 指令会将返回地址设置到 rip 寄存器中，然后跳转到该位置执行。\npop rip jmp rip 实例 // file name: call.c int func1(int a, int b, int *c) { return a + b; } void func2(int *c) { int a = 99; int b = 1; int d = func1(a, b, c); a = a + d; } int main() { int *c = 0; func2(c); return 0; } 使用 gcc -g -no-pie -o call call.c 编译以上代码。然后使用 gdb -q call 调试。\n进入 gdb 后首先，set disassembly-flavor intel 将 disassemble 命令转换出 的汇编码设置成 intel 格式，当然如果熟悉 AT\u0026T 汇编格式可以不执行这个命令。\n然后 b main 在 main 函数处设置断点。使用 disassemble main 可以查看 main 函数 的汇编码。\n0x0000000000401202 \u003c+0\u003e: endbr64 0x0000000000401206 \u003c+4\u003e: push rbp 0x0000000000401207 \u003c+5\u003e: mov rbp,rsp 0x000000000040120a \u003c+8\u003e: sub rsp,0x10 =\u003e 0x000000000040120e \u003c+12\u003e: mov QWORD PTR [rbp-0x8],0x0 0x0000000000401216 \u003c+20\u003e: mov rax,QWORD PTR [rbp-0x8] 0x000000000040121a \u003c+24\u003e: mov rdi,rax 0x000000000040121d \u003c+27\u003e: call 0x401122 \u003cfunc2\u003e 0x0000000000401222 \u003c+32\u003e: mov eax,0x0 0x0000000000401227 \u003c+37\u003e: leave 0x0000000000401228 \u003c+38\u003e: ret 可以使用 p/x $rbp p/x $rsp p/x $pc 寄存器中的的内容。\n(gdb) p/x $rbp $5 = 0x7fffffffe290 (gdb) p/x $rsp $6 = 0x7fffffffe280 (gdb) p/x $pc $7 = 0x40120e 在 call 命令之前的 mov rdi,rax 命令为函数的参数传递。函数的参数传递不同的 类型所使用的寄存器也有所不同，如 integer 类型，使用的寄存器依次为 rdi rsi rdx rcx r8 r9，如果 integer 参数多于可以使用的寄存器个数会使用栈来进行 参数传递，对于不同类型所使用的寄存器这个 PDF 有详细的介绍。\n使用 si 来进行指令级别的单步进入调试。当执行完 call 命令后再次查看三个寄存器 的内容。\n(gdb) p/x $rbp $8 = 0x7fffffffe290 (gdb) p/x $rsp $9 = 0x7fffffffe278 (gdb) p/x $pc $10 = 0x401122 使用 disassemble func2 来查看 func2 函数的汇编码。\n=\u003e 0x0000000000401122 \u003c+0\u003e: endbr64 0x0000000000401126 \u003c+4\u003e: push rbp 0x0000000000401127 \u003c+5\u003e: mov rbp,rsp 0x000000000040112a \u003c+8\u003e: sub rsp,0x18 0x000000000040112e \u003c+12\u003e: mov QWORD PTR [rbp-0x18],rdi 0x0000000000401132 \u003c+16\u003e: mov DWORD PTR [rbp-0xc],0x63 0x0000000000401139 \u003c+23\u003e: mov DWORD PTR [rbp-0x8],0x1 0x0000000000401140 \u003c+30\u003e: mov rdx,QWORD PTR [rbp-0x18] 0x0000000000401144 \u003c+34\u003e: mov ecx,DWORD PTR [rbp-0x8] 0x0000000000401147 \u003c+37\u003e: mov eax,DWORD PTR [rbp-0xc] 0x000000000040114a \u003c+40\u003e: mov esi,ecx 0x000000000040114c \u003c+42\u003e: mov edi,eax 0x000000000040114e \u003c+44\u003e: call 0x401106 \u003cfunc1\u003e 0x0000000000401153 \u003c+49\u003e: mov DWORD PTR [rbp-0x4],eax 0x0000000000401156 \u003c+52\u003e: mov eax,DWORD PTR [rbp-0x4] 0x0000000000401159 \u003c+55\u003e: add DWORD PTR [rbp-0xc],eax 0x000000000040115c \u003c+58\u003e: nop 0x000000000040115d \u003c+59\u003e: leave 0x000000000040115e \u003c+60\u003e: ret p/x *(long *)$rsp 可以查看当前 rsp 寄存器所指向的位置的内容 0x401222。\n可以看到这个地址就是 main 函数中 call 指令之后的那条指令的地址，也就是返回地址。\n然后使用 si 继续执行，当执行完 push rbp 指令后，继续查看这三个寄存器中的内容。\n(gdb) p/x $rbp $12 = 0x7fffffffe290 (gdb) p/x $rsp $13 = 0x7fffffffe270 (gdb) p/x $pc $14 = 0x401127 同样使用 p/x *(long *)$rsp 查看 rsp 寄存器所指向的位置中的内容 0x7fffffffe290。 这个值就是现在 rbp 寄存器中的内容，而下一条指令 mov rbp,rsp 就是将 rbp 指向 当前 rsp 所指向的位置。\n(gdb) p/x $rbp $17 = 0x7fffffffe270 (gdb) p/x $rsp $18 = 0x7fffffffe270 下面的一部分命令就是将函数的参数和局部变量放入栈中。\n接下来，直接跳转到 func2 函数中的 leave 指令位置，当执行完 leave 指令后再次 查看三个寄存器中的值。\n(gdb) p/x $rbp $17 = 0x7fffffffe290 (gdb) p/x $rsp $18 = 0x7fffffffe278 (gdb) p/x $pc $19 = 0x40115e 可以看到 rbp 寄存器又指向了在 func2 函数调用之前所指向的位置，rsp 寄存器目前指向 的为返回地址的位置。\n然后执行 ret 指令后，三个寄存器全部变为调用 func2 之前的状态，对 func2 的函数 调用过程执行完成。\n(gdb) p/x $rbp $21 = 0x7fffffffe290 (gdb) p/x $rsp $22 = 0x7fffffffe280 (gdb) p/x $pc $23 = 0x401222 上述过程的图示。\nVariable Length Array(VLA) 和 alloca 在 ISO C99 之后 C 语言支持 variable length array，就是使用变量作为数组的大小。 而这个数据依然是放在 stack 当中，alloca 的实现方式和 VLA 基本相同放在一起探讨。\n使用下面的 C 代码来进行演示\n// file name: vla.c int func1(int n) { int b = 0xbe; int a[n]; int c = 0xef; a[n - 1] = n * 2; a[n - 1] += 2; return a[n - 1]; } int main() { int a = func1(10); a = func1(100); return 0; } 同样使用 gcc -g -no-pie -o vla vla.c，然后使用 gdb -q vla 进行调试， 使用 disassemble func1 可以得到它的如下汇编码\n0x0000000000401136 \u003c+0\u003e: endbr64 0x000000000040113a \u003c+4\u003e: push rbp 0x000000000040113b \u003c+5\u003e: mov rbp,rsp 0x000000000040113e \u003c+8\u003e: push rbx 0x000000000040113f \u003c+9\u003e: sub rsp,0x38 0x0000000000401143 \u003c+13\u003e: mov DWORD PTR [rbp-0x34],edi 0x0000000000401146 \u003c+16\u003e: mov rax,QWORD PTR fs:0x28 0x000000000040114f \u003c+25\u003e: mov QWORD PTR [rbp-0x18],rax 0x0000000000401153 \u003c+29\u003e: xor eax,eax 0x0000000000401155 \u003c+31\u003e: mov rax,rsp 0x0000000000401158 \u003c+34\u003e: mov rsi,rax 0x000000000040115b \u003c+37\u003e: mov DWORD PTR [rbp-0x30],0xbe 0x0000000000401162 \u003c+44\u003e: mov eax,DWORD PTR [rbp-0x34] 0x0000000000401165 \u003c+47\u003e: movsxd rdx,eax 0x0000000000401168 \u003c+50\u003e: sub rdx,0x1 0x000000000040116c \u003c+54\u003e: mov QWORD PTR [rbp-0x28],rdx 0x0000000000401170 \u003c+58\u003e: movsxd rdx,eax 0x0000000000401173 \u003c+61\u003e: mov r8,rdx 0x0000000000401176 \u003c+64\u003e: mov r9d,0x0 0x000000000040117c \u003c+70\u003e: movsxd rdx,eax 0x000000000040117f \u003c+73\u003e: mov rcx,rdx 0x0000000000401182 \u003c+76\u003e: mov ebx,0x0 0x0000000000401187 \u003c+81\u003e: cdqe 0x0000000000401189 \u003c+83\u003e: lea rdx,[rax*4+0x0] 0x0000000000401191 \u003c+91\u003e: mov eax,0x10 0x0000000000401196 \u003c+96\u003e: sub rax,0x1 0x000000000040119a \u003c+100\u003e: add rax,rdx 0x000000000040119d \u003c+103\u003e: mov ebx,0x10 0x00000000004011a2 \u003c+108\u003e: mov edx,0x0 0x00000000004011a7 \u003c+113\u003e: div rbx 0x00000000004011aa \u003c+116\u003e: imul rax,rax,0x10 0x00000000004011ae \u003c+120\u003e: mov rcx,rax 0x00000000004011b1 \u003c+123\u003e: and rcx,0xfffffffffffff000 0x00000000004011b8 \u003c+130\u003e: mov rdx,rsp 0x00000000004011bb \u003c+133\u003e: sub rdx,rcx 0x00000000004011be \u003c+136\u003e: cmp rsp,rdx 0x00000000004011c1 \u003c+139\u003e: je 0x4011d5 \u003cfunc1+159\u003e 0x00000000004011c3 \u003c+141\u003e: sub rsp,0x1000 0x00000000004011ca \u003c+148\u003e: or QWORD PTR [rsp+0xff8],0x0 0x00000000004011d3 \u003c+157\u003e: jmp 0x4011be \u003cfunc1+136\u003e 0x00000000004011d5 \u003c+159\u003e: mov rdx,rax 0x00000000004011d8 \u003c+162\u003e: and edx,0xfff 0x00000000004011de \u003c+168\u003e: sub rsp,rdx 0x00000000004011e1 \u003c+171\u003e: mov rdx,rax 0x00000000004011e4 \u003c+174\u003e: and edx,0xfff 0x00000000004011ea \u003c+180\u003e: test rdx,rdx 0x00000000004011ed \u003c+183\u003e: je 0x4011ff \u003cfunc1+201\u003e 0x00000000004011ef \u003c+185\u003e: and eax,0xfff 0x00000000004011f4 \u003c+190\u003e: sub rax,0x8 0x00000000004011f8 \u003c+194\u003e: add rax,rsp 0x00000000004011fb \u003c+197\u003e: or QWORD PTR [rax],0x0 0x00000000004011ff \u003c+201\u003e: mov rax,rsp 0x0000000000401202 \u003c+204\u003e: add rax,0x3 0x0000000000401206 \u003c+208\u003e: shr rax,0x2 0x000000000040120a \u003c+212\u003e: shl rax,0x2 0x000000000040120e \u003c+216\u003e: mov QWORD PTR [rbp-0x20],rax 0x0000000000401212 \u003c+220\u003e: mov DWORD PTR [rbp-0x2c],0xef 0x0000000000401219 \u003c+227\u003e: mov eax,DWORD PTR [rbp-0x34] 0x000000000040121c \u003c+230\u003e: lea edx,[rax-0x1] 0x000000000040121f \u003c+233\u003e: mov eax,DWORD PTR [rbp-0x34] 0x0000000000401222 \u003c+236\u003e: lea ecx,[rax+rax*1] 0x0000000000401225 \u003c+239\u003e: mov rax,QWORD PTR [rbp-0x20] 0x0000000000401229 \u003c+243\u003e: movsxd rdx,edx 0x000000000040122c \u003c+246\u003e: mov DWORD PTR [rax+rdx*4],ecx 0x000000000040122f \u003c+249\u003e: mov eax,DWORD PTR [rbp-0x34] 0x0000000000401232 \u003c+252\u003e: lea edx,[rax-0x1] 0x0000000000401235 \u003c+255\u003e: mov rax,QWORD PTR [rbp-0x20] 0x0000000000401239 \u003c+259\u003e: movsxd rdx,edx 0x000000000040123c \u003c+262\u003e: mov eax,DWORD PTR [rax+rdx*4] 0x000000000040123f \u003c+265\u003e: mov edx,DWORD PTR [rbp-0x34] 0x0000000000401242 \u003c+268\u003e: sub edx,0x1 0x0000000000401245 \u003c+271\u003e: lea ecx,[rax+0x2] 0x0000000000401248 \u003c+274\u003e: mov rax,QWORD PTR [rbp-0x20] 0x000000000040124c \u003c+278\u003e: movsxd rdx,edx 0x000000000040124f \u003c+281\u003e: mov DWORD PTR [rax+rdx*4],ecx 0x0000000000401252 \u003c+284\u003e: mov eax,DWORD PTR [rbp-0x34] 0x0000000000401255 \u003c+287\u003e: lea edx,[rax-0x1] 0x0000000000401258 \u003c+290\u003e: mov rax,QWORD PTR [rbp-0x20] 0x000000000040125c \u003c+294\u003e: movsxd rdx,edx 0x000000000040125f \u003c+297\u003e: mov eax,DWORD PTR [rax+rdx*4] 0x0000000000401262 \u003c+300\u003e: mov rsp,rsi 0x0000000000401265 \u003c+303\u003e: mov rdx,QWORD PTR [rbp-0x18] 0x0000000000401269 \u003c+307\u003e: sub rdx,QWORD PTR fs:0x28 0x0000000000401272 \u003c+316\u003e: je 0x401279 \u003cfunc1+323\u003e 0x0000000000401274 \u003c+318\u003e: call 0x401040 \u003c__stack_chk_fail@plt\u003e 0x0000000000401279 \u003c+323\u003e: mov rbx,QWORD PTR [rbp-0x8] 0x000000000040127d \u003c+327\u003e: leave 0x000000000040127e \u003c+328\u003e: ret 0x0000000000401146 \u003c+16\u003e: mov rax,QWORD PTR fs:0x28 0x000000000040114f \u003c+25\u003e: mov QWORD PTR [rbp-0x18],rax ... 0x0000000000401265 \u003c+303\u003e: mov rdx,QWORD PTR [rbp-0x18] 0x0000000000401269 \u003c+307\u003e: sub rdx,QWORD PTR fs:0x28 0x0000000000401272 \u003c+316\u003e: je 0x401279 \u003cfunc1+323\u003e 0x0000000000401274 \u003c+318\u003e: call 0x401040 \u003c__stack_chk_fail@plt\u003e 0x0000000000401279 \u003c+323\u003e: mov rbx,QWORD PTR [rbp-0x8] 这两条指令就是设置图片中的 stack guard，用于检查对栈的操作是否越界了。可以看到 在这个函数的最后会检查这个位置的值是否和原始相同，如果相同就会跳转到 0x401279处 执行，否则就会执行 __stack_chk_fail 函数，产生 segmentation falut 错误。这个检查 主要是为了防止修改掉 prev rbp 和返回地址从而导致程序执行错误。\n0x0000000000401153 \u003c+29\u003e: xor eax,eax 0x0000000000401155 \u003c+31\u003e: mov rax,rsp 0x0000000000401158 \u003c+34\u003e: mov rsi,rax 设置 rsi 暂存 rsp 当前的值。\n从 0x401162 到 0x40120e 为计算和设置 VLA 的开始地址，即图中的蓝色部分，同时也将 rsp 设置到栈底。\n从 0x401219 到 0x40124f 对应的为 C 代码中的对 a[n-1] 赋值的两行。\n从 0x401252 到 0x40125f 对应的为 C 代码中的 return a[n-1]。\n0x0000000000401262 \u003c+300\u003e: mov rsp,rsi 恢复 rsp 寄存器为 0x7fffffffe230。\n然后正常退出函数。\n为什么在函数开头和结尾 push rbx and mov rbx,QWORD PTR [rbp-0x8]?\n根据上图可以看到被调用的函数如果有用到 rbx 寄存器，是有责任保存这个寄存器的。\nRef what registers are preserved through a linux x86_64 function call what does the endbr64 instruction actually do gcc VLA x86 and amd64 instruction reference x86 what does movsxd rdx edx instruction mean x86-64 reference sheet.pdf difference between je jne and jz jnz why does this memory address fs0x28 fs0x28 have a random value ","wordCount":"1227","inLanguage":"zh-cn","datePublished":"2024-04-17T11:36:45+08:00","dateModified":"2024-04-17T11:36:45+08:00","author":{"@type":"Person","name":"Jiao shijie"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jiaoshijie.github.io/posts/function_call_and_vla_and_alloca/"},"publisher":{"@type":"Organization","name":"Jsj's Blog","logo":{"@type":"ImageObject","url":"https://jiaoshijie.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jiaoshijie.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://jiaoshijie.github.io/favicon.ico alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://jiaoshijie.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://jiaoshijie.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://jiaoshijie.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://jiaoshijie.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">C 语言函数调用和VLA和alloca栈的变化探讨</h1></header><div class=post-content><p><strong>NOTE</strong>: 以下讨论使用的平台为 x86-64，使用的编译器为 gcc，以下提供的伪汇编码
采用 intel 格式。</p><p>文章中提到的代码，可以在 <a href=https://github.com/jiaoshijie/code_misc/tree/main/c-like/function_call_VLA_alloca>Code</a> 找到。</p><h2 id=一些重要的寄存器和指令>一些重要的寄存器和指令<a hidden class=anchor aria-hidden=true href=#一些重要的寄存器和指令>#</a></h2><p>函数调用过程中，比较重要的寄存器主要有三个 <code>rip</code> <code>rbp</code> <code>rsp</code>。</p><ul><li><code>rip</code> 寄存器存放的为下一条要执行指令的地址，Instruction Pointer。</li><li><code>rbp</code> 为基寄存器，存放的为前一个 <code>rbp</code> 的值，Base Pointer。</li><li><code>rsp</code> 为栈寄存器，一直指向函数调用栈的底部，Stack Pointer。</li></ul><p>比较重要的指令有 <code>call</code> <code>push</code> <code>pop</code> <code>leave</code> <code>ret</code>。</p><p><code>call addr</code> 指令会首先将 call 返回之后要执行的地址压入栈中(返回地址)，设置 <code>rip</code>
的值为 addr，然后跳转的这个位置去执行，大致可以等效于一下指令。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=c1># 假设当执行到 call 指令时 CPU 就会自动设置 rip 寄存器为下一条要执行的指令
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>push</span> <span class=no>rip</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rip</span><span class=p>,</span> <span class=no>addr</span>
</span></span><span class=line><span class=cl><span class=c1># 按理设置了 rip 寄存器，CPU 就会去执行 rip 地址的指令，这里写 jmp 只是想要更清晰的表示 call 的流程
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>jmp</span> <span class=no>addr</span>
</span></span></code></pre></div><p><code>push rbp</code> 指令会将 rsp 寄存器下移一个 word 的长度，rbp 中的内容移动到 rsp
寄存器所指向的地址中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>sub</span> <span class=no>rsp</span><span class=p>,</span> <span class=mi>0x8</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span> <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=p>],</span> <span class=no>rbp</span>
</span></span></code></pre></div><p><code>pop rbp</code> 指令会将当前 rsp 寄存器所指向地址中的内容移动到 rbp 寄存器中，并将 rsp
寄存器上移一个 word 的长度。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rbp</span><span class=p>,</span> <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nf>add</span> <span class=no>rsp</span><span class=p>,</span> <span class=mi>0x8</span>
</span></span></code></pre></div><p><code>leave</code> 指令会将 rsp 寄存器指向 rbp 当前指向的位置(这个位置存储的为前一个 rbp
的内容)，然后将 rbp 寄存器的内容设置为 前一个 rbp 的位置。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span> <span class=no>rsp</span><span class=p>,</span> <span class=no>rbp</span>
</span></span><span class=line><span class=cl><span class=nf>pop</span> <span class=no>rbp</span>
</span></span></code></pre></div><p><code>ret</code> 指令会将返回地址设置到 rip 寄存器中，然后跳转到该位置执行。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>pop</span> <span class=no>rip</span>
</span></span><span class=line><span class=cl><span class=nf>jmp</span> <span class=no>rip</span>
</span></span></code></pre></div><h2 id=实例>实例<a hidden class=anchor aria-hidden=true href=#实例>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// file name: call.c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>func1</span><span class=p>(</span><span class=kt>int</span> <span class=n>a</span><span class=p>,</span> <span class=kt>int</span> <span class=n>b</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=n>c</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>func2</span><span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=n>c</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>99</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>d</span> <span class=o>=</span> <span class=nf>func1</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>d</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=o>*</span><span class=n>c</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>func2</span><span class=p>(</span><span class=n>c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>使用 <code>gcc -g -no-pie -o call call.c</code> 编译以上代码。然后使用 <code>gdb -q call</code> 调试。</p><p>进入 <code>gdb</code> 后首先，<code>set disassembly-flavor intel</code> 将 <code>disassemble</code> 命令转换出
的汇编码设置成 intel 格式，当然如果熟悉 AT&amp;T 汇编格式可以不执行这个命令。</p><p>然后 <code>b main</code> 在 main 函数处设置断点。使用 <code>disassemble main</code> 可以查看 main 函数
的汇编码。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401202</span> <span class=err>&lt;+</span><span class=mi>0</span><span class=err>&gt;</span><span class=p>:</span>     <span class=no>endbr64</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401206</span> <span class=err>&lt;+</span><span class=mi>4</span><span class=err>&gt;</span><span class=p>:</span>     <span class=no>push</span>   <span class=no>rbp</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401207</span> <span class=err>&lt;+</span><span class=mi>5</span><span class=err>&gt;</span><span class=p>:</span>     <span class=no>mov</span>    <span class=no>rbp</span><span class=p>,</span><span class=no>rsp</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x000000000040120a</span> <span class=err>&lt;+</span><span class=mi>8</span><span class=err>&gt;</span><span class=p>:</span>     <span class=no>sub</span>    <span class=no>rsp</span><span class=p>,</span><span class=mi>0x10</span>
</span></span><span class=line><span class=cl><span class=err>=&gt;</span> <span class=err>0</span><span class=nf>x000000000040120e</span> <span class=err>&lt;+</span><span class=mi>12</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x8</span><span class=p>],</span><span class=mi>0x0</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401216</span> <span class=err>&lt;+</span><span class=mi>20</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>rax</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x8</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x000000000040121a</span> <span class=err>&lt;+</span><span class=mi>24</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>rdi</span><span class=p>,</span><span class=no>rax</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x000000000040121d</span> <span class=err>&lt;+</span><span class=mi>27</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>call</span>   <span class=mh>0x401122</span> <span class=p>&lt;</span><span class=no>func2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401222</span> <span class=err>&lt;+</span><span class=mi>32</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=mi>0x0</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401227</span> <span class=err>&lt;+</span><span class=mi>37</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>leave</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401228</span> <span class=err>&lt;+</span><span class=mi>38</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>ret</span>
</span></span></code></pre></div><p>可以使用 <code>p/x $rbp</code> <code>p/x $rsp</code> <code>p/x $pc</code> 寄存器中的的内容。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$rbp</span>
</span></span><span class=line><span class=cl><span class=nv>$5</span> <span class=o>=</span> 0x7fffffffe290
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$rsp</span>
</span></span><span class=line><span class=cl><span class=nv>$6</span> <span class=o>=</span> 0x7fffffffe280
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$pc</span>
</span></span><span class=line><span class=cl><span class=nv>$7</span> <span class=o>=</span> 0x40120e
</span></span></code></pre></div><p>在 <code>call</code> 命令之前的 <code>mov rdi,rax</code> 命令为函数的参数传递。函数的参数传递不同的
类型所使用的寄存器也有所不同，如 integer 类型，使用的寄存器依次为 <code>rdi</code> <code>rsi</code>
<code>rdx</code> <code>rcx</code> <code>r8</code> <code>r9</code>，如果 integer 参数多于可以使用的寄存器个数会使用栈来进行
参数传递，对于不同类型所使用的寄存器这个 <a href=http://www.uclibc.org/docs/psABI-x86_64.pdf>PDF</a> 有详细的介绍。</p><p>使用 <code>si</code> 来进行指令级别的单步进入调试。当执行完 <code>call</code> 命令后再次查看三个寄存器
的内容。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$rbp</span>
</span></span><span class=line><span class=cl><span class=nv>$8</span> <span class=o>=</span> 0x7fffffffe290
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$rsp</span>
</span></span><span class=line><span class=cl><span class=nv>$9</span> <span class=o>=</span> 0x7fffffffe278
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$pc</span>
</span></span><span class=line><span class=cl><span class=nv>$10</span> <span class=o>=</span> 0x401122
</span></span></code></pre></div><p>使用 <code>disassemble func2</code> 来查看 func2 函数的汇编码。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>=&gt;</span> <span class=err>0</span><span class=nf>x0000000000401122</span> <span class=err>&lt;+</span><span class=mi>0</span><span class=err>&gt;</span><span class=p>:</span>     <span class=no>endbr64</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401126</span> <span class=err>&lt;+</span><span class=mi>4</span><span class=err>&gt;</span><span class=p>:</span>     <span class=no>push</span>   <span class=no>rbp</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401127</span> <span class=err>&lt;+</span><span class=mi>5</span><span class=err>&gt;</span><span class=p>:</span>     <span class=no>mov</span>    <span class=no>rbp</span><span class=p>,</span><span class=no>rsp</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x000000000040112a</span> <span class=err>&lt;+</span><span class=mi>8</span><span class=err>&gt;</span><span class=p>:</span>     <span class=no>sub</span>    <span class=no>rsp</span><span class=p>,</span><span class=mi>0x18</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x000000000040112e</span> <span class=err>&lt;+</span><span class=mi>12</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x18</span><span class=p>],</span><span class=no>rdi</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401132</span> <span class=err>&lt;+</span><span class=mi>16</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0xc</span><span class=p>],</span><span class=mi>0x63</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401139</span> <span class=err>&lt;+</span><span class=mi>23</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x8</span><span class=p>],</span><span class=mi>0x1</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401140</span> <span class=err>&lt;+</span><span class=mi>30</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>rdx</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x18</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401144</span> <span class=err>&lt;+</span><span class=mi>34</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>ecx</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x8</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401147</span> <span class=err>&lt;+</span><span class=mi>37</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0xc</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x000000000040114a</span> <span class=err>&lt;+</span><span class=mi>40</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>esi</span><span class=p>,</span><span class=no>ecx</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x000000000040114c</span> <span class=err>&lt;+</span><span class=mi>42</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>edi</span><span class=p>,</span><span class=no>eax</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x000000000040114e</span> <span class=err>&lt;+</span><span class=mi>44</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>call</span>   <span class=mh>0x401106</span> <span class=p>&lt;</span><span class=no>func1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401153</span> <span class=err>&lt;+</span><span class=mi>49</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x4</span><span class=p>],</span><span class=no>eax</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401156</span> <span class=err>&lt;+</span><span class=mi>52</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x4</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x0000000000401159</span> <span class=err>&lt;+</span><span class=mi>55</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>add</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0xc</span><span class=p>],</span><span class=no>eax</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x000000000040115c</span> <span class=err>&lt;+</span><span class=mi>58</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>nop</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x000000000040115d</span> <span class=err>&lt;+</span><span class=mi>59</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>leave</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nf>x000000000040115e</span> <span class=err>&lt;+</span><span class=mi>60</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>ret</span>
</span></span></code></pre></div><p><code>p/x *(long *)$rsp</code> 可以查看当前 rsp 寄存器所指向的位置的内容 <code>0x401222</code>。</p><p>可以看到这个地址就是 main 函数中 <code>call</code> 指令之后的那条指令的地址，也就是返回地址。</p><p>然后使用 <code>si</code> 继续执行，当执行完 <code>push rbp</code> 指令后，继续查看这三个寄存器中的内容。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$rbp</span>
</span></span><span class=line><span class=cl><span class=nv>$12</span> <span class=o>=</span> 0x7fffffffe290
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$rsp</span>
</span></span><span class=line><span class=cl><span class=nv>$13</span> <span class=o>=</span> 0x7fffffffe270
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$pc</span>
</span></span><span class=line><span class=cl><span class=nv>$14</span> <span class=o>=</span> 0x401127
</span></span></code></pre></div><p>同样使用 <code>p/x *(long *)$rsp</code> 查看 rsp 寄存器所指向的位置中的内容 <code>0x7fffffffe290</code>。
这个值就是现在 rbp 寄存器中的内容，而下一条指令 <code>mov rbp,rsp</code> 就是将 rbp 指向
当前 rsp 所指向的位置。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$rbp</span>
</span></span><span class=line><span class=cl><span class=nv>$17</span> <span class=o>=</span> 0x7fffffffe270
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$rsp</span>
</span></span><span class=line><span class=cl><span class=nv>$18</span> <span class=o>=</span> 0x7fffffffe270
</span></span></code></pre></div><p>下面的一部分命令就是将函数的参数和局部变量放入栈中。</p><p>接下来，直接跳转到 func2 函数中的 <code>leave</code> 指令位置，当执行完 <code>leave</code> 指令后再次
查看三个寄存器中的值。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$rbp</span>
</span></span><span class=line><span class=cl><span class=nv>$17</span> <span class=o>=</span> 0x7fffffffe290
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$rsp</span>
</span></span><span class=line><span class=cl><span class=nv>$18</span> <span class=o>=</span> 0x7fffffffe278
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$pc</span>
</span></span><span class=line><span class=cl><span class=nv>$19</span> <span class=o>=</span> 0x40115e
</span></span></code></pre></div><p>可以看到 rbp 寄存器又指向了在 func2 函数调用之前所指向的位置，rsp 寄存器目前指向
的为返回地址的位置。</p><p>然后执行 <code>ret</code> 指令后，三个寄存器全部变为调用 func2 之前的状态，对 func2 的函数
调用过程执行完成。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$rbp</span>
</span></span><span class=line><span class=cl><span class=nv>$21</span> <span class=o>=</span> 0x7fffffffe290
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$rsp</span>
</span></span><span class=line><span class=cl><span class=nv>$22</span> <span class=o>=</span> 0x7fffffffe280
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> p/x <span class=nv>$pc</span>
</span></span><span class=line><span class=cl><span class=nv>$23</span> <span class=o>=</span> 0x401222
</span></span></code></pre></div><p>上述过程的图示。</p><p><img loading=lazy src=../../images/function_call_VLA_alloca_01.png#center alt="function call stack layout"></p><h2 id=variable-length-arrayvla-和-alloca>Variable Length Array(VLA) 和 alloca<a hidden class=anchor aria-hidden=true href=#variable-length-arrayvla-和-alloca>#</a></h2><p>在 ISO C99 之后 C 语言支持 variable length array，就是使用变量作为数组的大小。
而这个数据依然是放在 stack 当中，alloca 的实现方式和 VLA 基本相同放在一起探讨。</p><p>使用下面的 C 代码来进行演示</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// file name: vla.c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>func1</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>b</span> <span class=o>=</span> <span class=mh>0xbe</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>a</span><span class=p>[</span><span class=n>n</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>c</span> <span class=o>=</span> <span class=mh>0xef</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span><span class=p>[</span><span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>n</span> <span class=o>*</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span><span class=p>[</span><span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>a</span><span class=p>[</span><span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=nf>func1</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=nf>func1</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>同样使用 <code>gcc -g -no-pie -o vla vla.c</code>，然后使用 <code>gdb -q vla</code> 进行调试，
使用 <code>disassemble func1</code> 可以得到它的如下汇编码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401136</span> <span class=err>&lt;+</span><span class=mi>0</span><span class=err>&gt;</span><span class=p>:</span>     <span class=no>endbr64</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040113a</span> <span class=err>&lt;+</span><span class=mi>4</span><span class=err>&gt;</span><span class=p>:</span>     <span class=no>push</span>   <span class=no>rbp</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040113b</span> <span class=err>&lt;+</span><span class=mi>5</span><span class=err>&gt;</span><span class=p>:</span>     <span class=no>mov</span>    <span class=no>rbp</span><span class=p>,</span><span class=no>rsp</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040113e</span> <span class=err>&lt;+</span><span class=mi>8</span><span class=err>&gt;</span><span class=p>:</span>     <span class=no>push</span>   <span class=no>rbx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040113f</span> <span class=err>&lt;+</span><span class=mi>9</span><span class=err>&gt;</span><span class=p>:</span>     <span class=no>sub</span>    <span class=no>rsp</span><span class=p>,</span><span class=mi>0x38</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401143</span> <span class=err>&lt;+</span><span class=mi>13</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x34</span><span class=p>],</span><span class=no>edi</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401146</span> <span class=err>&lt;+</span><span class=mi>16</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>rax</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=no>fs</span><span class=p>:</span><span class=mi>0x28</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040114f</span> <span class=err>&lt;+</span><span class=mi>25</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x18</span><span class=p>],</span><span class=no>rax</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401153</span> <span class=err>&lt;+</span><span class=mi>29</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>xor</span>    <span class=no>eax</span><span class=p>,</span><span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401155</span> <span class=err>&lt;+</span><span class=mi>31</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>rax</span><span class=p>,</span><span class=no>rsp</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401158</span> <span class=err>&lt;+</span><span class=mi>34</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>rsi</span><span class=p>,</span><span class=no>rax</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040115b</span> <span class=err>&lt;+</span><span class=mi>37</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x30</span><span class=p>],</span><span class=mi>0xbe</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401162</span> <span class=err>&lt;+</span><span class=mi>44</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x34</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401165</span> <span class=err>&lt;+</span><span class=mi>47</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>movsxd</span> <span class=no>rdx</span><span class=p>,</span><span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401168</span> <span class=err>&lt;+</span><span class=mi>50</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>sub</span>    <span class=no>rdx</span><span class=p>,</span><span class=mi>0x1</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040116c</span> <span class=err>&lt;+</span><span class=mi>54</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x28</span><span class=p>],</span><span class=no>rdx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401170</span> <span class=err>&lt;+</span><span class=mi>58</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>movsxd</span> <span class=no>rdx</span><span class=p>,</span><span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401173</span> <span class=err>&lt;+</span><span class=mi>61</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>r8</span><span class=p>,</span><span class=no>rdx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401176</span> <span class=err>&lt;+</span><span class=mi>64</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>r9d</span><span class=p>,</span><span class=mi>0x0</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040117c</span> <span class=err>&lt;+</span><span class=mi>70</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>movsxd</span> <span class=no>rdx</span><span class=p>,</span><span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040117f</span> <span class=err>&lt;+</span><span class=mi>73</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>rcx</span><span class=p>,</span><span class=no>rdx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401182</span> <span class=err>&lt;+</span><span class=mi>76</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>ebx</span><span class=p>,</span><span class=mi>0x0</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401187</span> <span class=err>&lt;+</span><span class=mi>81</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>cdqe</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401189</span> <span class=err>&lt;+</span><span class=mi>83</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>lea</span>    <span class=no>rdx</span><span class=p>,[</span><span class=no>rax</span><span class=p>*</span><span class=mi>4</span><span class=err>+</span><span class=mi>0x0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401191</span> <span class=err>&lt;+</span><span class=mi>91</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=mi>0x10</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401196</span> <span class=err>&lt;+</span><span class=mi>96</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>sub</span>    <span class=no>rax</span><span class=p>,</span><span class=mi>0x1</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040119a</span> <span class=err>&lt;+</span><span class=mi>100</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>add</span>    <span class=no>rax</span><span class=p>,</span><span class=no>rdx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040119d</span> <span class=err>&lt;+</span><span class=mi>103</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>ebx</span><span class=p>,</span><span class=mi>0x10</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011a2</span> <span class=err>&lt;+</span><span class=mi>108</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>edx</span><span class=p>,</span><span class=mi>0x0</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011a7</span> <span class=err>&lt;+</span><span class=mi>113</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>div</span>    <span class=no>rbx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011aa</span> <span class=err>&lt;+</span><span class=mi>116</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>imul</span>   <span class=no>rax</span><span class=p>,</span><span class=no>rax</span><span class=p>,</span><span class=mi>0x10</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011ae</span> <span class=err>&lt;+</span><span class=mi>120</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>rcx</span><span class=p>,</span><span class=no>rax</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011b1</span> <span class=err>&lt;+</span><span class=mi>123</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>and</span>    <span class=no>rcx</span><span class=p>,</span><span class=mi>0xfffffffffffff000</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011b8</span> <span class=err>&lt;+</span><span class=mi>130</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>rdx</span><span class=p>,</span><span class=no>rsp</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011bb</span> <span class=err>&lt;+</span><span class=mi>133</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>sub</span>    <span class=no>rdx</span><span class=p>,</span><span class=no>rcx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011be</span> <span class=err>&lt;+</span><span class=mi>136</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>cmp</span>    <span class=no>rsp</span><span class=p>,</span><span class=no>rdx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011c1</span> <span class=err>&lt;+</span><span class=mi>139</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>je</span>     <span class=mh>0x4011d5</span> <span class=p>&lt;</span><span class=no>func1</span><span class=p>+</span><span class=mi>159</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011c3</span> <span class=err>&lt;+</span><span class=mi>141</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>sub</span>    <span class=no>rsp</span><span class=p>,</span><span class=mi>0x1000</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011ca</span> <span class=err>&lt;+</span><span class=mi>148</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>or</span>     <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>0xff8</span><span class=p>],</span><span class=mi>0x0</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011d3</span> <span class=err>&lt;+</span><span class=mi>157</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>jmp</span>    <span class=mh>0x4011be</span> <span class=p>&lt;</span><span class=no>func1</span><span class=p>+</span><span class=mi>136</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011d5</span> <span class=err>&lt;+</span><span class=mi>159</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>rdx</span><span class=p>,</span><span class=no>rax</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011d8</span> <span class=err>&lt;+</span><span class=mi>162</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>and</span>    <span class=no>edx</span><span class=p>,</span><span class=mi>0xfff</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011de</span> <span class=err>&lt;+</span><span class=mi>168</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>sub</span>    <span class=no>rsp</span><span class=p>,</span><span class=no>rdx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011e1</span> <span class=err>&lt;+</span><span class=mi>171</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>rdx</span><span class=p>,</span><span class=no>rax</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011e4</span> <span class=err>&lt;+</span><span class=mi>174</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>and</span>    <span class=no>edx</span><span class=p>,</span><span class=mi>0xfff</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011ea</span> <span class=err>&lt;+</span><span class=mi>180</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>test</span>   <span class=no>rdx</span><span class=p>,</span><span class=no>rdx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011ed</span> <span class=err>&lt;+</span><span class=mi>183</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>je</span>     <span class=mh>0x4011ff</span> <span class=p>&lt;</span><span class=no>func1</span><span class=p>+</span><span class=mi>201</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011ef</span> <span class=err>&lt;+</span><span class=mi>185</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>and</span>    <span class=no>eax</span><span class=p>,</span><span class=mi>0xfff</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011f4</span> <span class=err>&lt;+</span><span class=mi>190</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>sub</span>    <span class=no>rax</span><span class=p>,</span><span class=mi>0x8</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011f8</span> <span class=err>&lt;+</span><span class=mi>194</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>add</span>    <span class=no>rax</span><span class=p>,</span><span class=no>rsp</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011fb</span> <span class=err>&lt;+</span><span class=mi>197</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>or</span>     <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rax</span><span class=p>],</span><span class=mi>0x0</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x00000000004011ff</span> <span class=err>&lt;+</span><span class=mi>201</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>rax</span><span class=p>,</span><span class=no>rsp</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401202</span> <span class=err>&lt;+</span><span class=mi>204</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>add</span>    <span class=no>rax</span><span class=p>,</span><span class=mi>0x3</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401206</span> <span class=err>&lt;+</span><span class=mi>208</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>shr</span>    <span class=no>rax</span><span class=p>,</span><span class=mi>0x2</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040120a</span> <span class=err>&lt;+</span><span class=mi>212</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>shl</span>    <span class=no>rax</span><span class=p>,</span><span class=mi>0x2</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040120e</span> <span class=err>&lt;+</span><span class=mi>216</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x20</span><span class=p>],</span><span class=no>rax</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401212</span> <span class=err>&lt;+</span><span class=mi>220</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x2c</span><span class=p>],</span><span class=mi>0xef</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401219</span> <span class=err>&lt;+</span><span class=mi>227</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x34</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040121c</span> <span class=err>&lt;+</span><span class=mi>230</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>lea</span>    <span class=no>edx</span><span class=p>,[</span><span class=no>rax-0x1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040121f</span> <span class=err>&lt;+</span><span class=mi>233</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x34</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401222</span> <span class=err>&lt;+</span><span class=mi>236</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>lea</span>    <span class=no>ecx</span><span class=p>,[</span><span class=no>rax</span><span class=err>+</span><span class=no>rax</span><span class=p>*</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401225</span> <span class=err>&lt;+</span><span class=mi>239</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>rax</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x20</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401229</span> <span class=err>&lt;+</span><span class=mi>243</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>movsxd</span> <span class=no>rdx</span><span class=p>,</span><span class=no>edx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040122c</span> <span class=err>&lt;+</span><span class=mi>246</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=no>rdx</span><span class=p>*</span><span class=mi>4</span><span class=p>],</span><span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040122f</span> <span class=err>&lt;+</span><span class=mi>249</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x34</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401232</span> <span class=err>&lt;+</span><span class=mi>252</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>lea</span>    <span class=no>edx</span><span class=p>,[</span><span class=no>rax-0x1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401235</span> <span class=err>&lt;+</span><span class=mi>255</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>rax</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x20</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401239</span> <span class=err>&lt;+</span><span class=mi>259</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>movsxd</span> <span class=no>rdx</span><span class=p>,</span><span class=no>edx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040123c</span> <span class=err>&lt;+</span><span class=mi>262</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=no>rdx</span><span class=p>*</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040123f</span> <span class=err>&lt;+</span><span class=mi>265</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>edx</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x34</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401242</span> <span class=err>&lt;+</span><span class=mi>268</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>sub</span>    <span class=no>edx</span><span class=p>,</span><span class=mi>0x1</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401245</span> <span class=err>&lt;+</span><span class=mi>271</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>lea</span>    <span class=no>ecx</span><span class=p>,[</span><span class=no>rax</span><span class=err>+</span><span class=mi>0x2</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401248</span> <span class=err>&lt;+</span><span class=mi>274</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>rax</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x20</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040124c</span> <span class=err>&lt;+</span><span class=mi>278</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>movsxd</span> <span class=no>rdx</span><span class=p>,</span><span class=no>edx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040124f</span> <span class=err>&lt;+</span><span class=mi>281</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=no>rdx</span><span class=p>*</span><span class=mi>4</span><span class=p>],</span><span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401252</span> <span class=err>&lt;+</span><span class=mi>284</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x34</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401255</span> <span class=err>&lt;+</span><span class=mi>287</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>lea</span>    <span class=no>edx</span><span class=p>,[</span><span class=no>rax-0x1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401258</span> <span class=err>&lt;+</span><span class=mi>290</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>rax</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x20</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040125c</span> <span class=err>&lt;+</span><span class=mi>294</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>movsxd</span> <span class=no>rdx</span><span class=p>,</span><span class=no>edx</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040125f</span> <span class=err>&lt;+</span><span class=mi>297</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>eax</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rax</span><span class=err>+</span><span class=no>rdx</span><span class=p>*</span><span class=mi>4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401262</span> <span class=err>&lt;+</span><span class=mi>300</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>rsp</span><span class=p>,</span><span class=no>rsi</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401265</span> <span class=err>&lt;+</span><span class=mi>303</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>rdx</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x18</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401269</span> <span class=err>&lt;+</span><span class=mi>307</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>sub</span>    <span class=no>rdx</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=no>fs</span><span class=p>:</span><span class=mi>0x28</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401272</span> <span class=err>&lt;+</span><span class=mi>316</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>je</span>     <span class=mh>0x401279</span> <span class=p>&lt;</span><span class=no>func1</span><span class=p>+</span><span class=mi>323</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401274</span> <span class=err>&lt;+</span><span class=mi>318</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>call</span>   <span class=mh>0x401040</span> <span class=p>&lt;</span><span class=no>__stack_chk_fail@plt</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401279</span> <span class=err>&lt;+</span><span class=mi>323</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>rbx</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x8</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040127d</span> <span class=err>&lt;+</span><span class=mi>327</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>leave</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040127e</span> <span class=err>&lt;+</span><span class=mi>328</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>ret</span>
</span></span></code></pre></div><p><img loading=lazy src=../../images/function_call_VLA_alloca_02.png#center alt="vla and alloca"></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401146</span> <span class=err>&lt;+</span><span class=mi>16</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>rax</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=no>fs</span><span class=p>:</span><span class=mi>0x28</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x000000000040114f</span> <span class=err>&lt;+</span><span class=mi>25</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x18</span><span class=p>],</span><span class=no>rax</span>
</span></span><span class=line><span class=cl><span class=na>...</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401265</span> <span class=err>&lt;+</span><span class=mi>303</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>rdx</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x18</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401269</span> <span class=err>&lt;+</span><span class=mi>307</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>sub</span>    <span class=no>rdx</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=no>fs</span><span class=p>:</span><span class=mi>0x28</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401272</span> <span class=err>&lt;+</span><span class=mi>316</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>je</span>     <span class=mh>0x401279</span> <span class=p>&lt;</span><span class=no>func1</span><span class=p>+</span><span class=mi>323</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401274</span> <span class=err>&lt;+</span><span class=mi>318</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>call</span>   <span class=mh>0x401040</span> <span class=p>&lt;</span><span class=no>__stack_chk_fail@plt</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401279</span> <span class=err>&lt;+</span><span class=mi>323</span><span class=err>&gt;</span><span class=p>:</span>   <span class=no>mov</span>    <span class=no>rbx</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rbp-0x8</span><span class=p>]</span>
</span></span></code></pre></div><p>这两条指令就是设置图片中的 stack guard，用于检查对栈的操作是否越界了。可以看到
在这个函数的最后会检查这个位置的值是否和原始相同，如果相同就会跳转到 0x401279处
执行，否则就会执行 __stack_chk_fail 函数，产生 segmentation falut 错误。这个检查
主要是为了防止修改掉 prev rbp 和返回地址从而导致程序执行错误。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401153</span> <span class=err>&lt;+</span><span class=mi>29</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>xor</span>    <span class=no>eax</span><span class=p>,</span><span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401155</span> <span class=err>&lt;+</span><span class=mi>31</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>rax</span><span class=p>,</span><span class=no>rsp</span>
</span></span><span class=line><span class=cl><span class=err>0</span><span class=nf>x0000000000401158</span> <span class=err>&lt;+</span><span class=mi>34</span><span class=err>&gt;</span><span class=p>:</span>    <span class=no>mov</span>    <span class=no>rsi</span><span class=p>,</span><span class=no>rax</span>
</span></span></code></pre></div><p>设置 rsi 暂存 rsp 当前的值。</p><p>从 0x401162 到 0x40120e 为计算和设置 VLA 的开始地址，即图中的蓝色部分，同时也将
rsp 设置到栈底。</p><p>从 0x401219 到 0x40124f 对应的为 C 代码中的对 <code>a[n-1]</code> 赋值的两行。</p><p>从 0x401252 到 0x40125f 对应的为 C 代码中的 <code>return a[n-1]</code>。</p><pre tabindex=0><code>0x0000000000401262 &lt;+300&gt;:   mov    rsp,rsi
</code></pre><p>恢复 rsp 寄存器为 0x7fffffffe230。</p><p>然后正常退出函数。</p><p>为什么在函数开头和结尾 <code>push rbx</code> and <code>mov rbx,QWORD PTR [rbp-0x8]</code>?</p><p><img loading=lazy src=../../images/function_call_VLA_alloca_03.png#center alt="vla and alloca"></p><p>根据上图可以看到被调用的函数如果有用到 rbx 寄存器，是有责任保存这个寄存器的。</p><h2 id=ref>Ref<a hidden class=anchor aria-hidden=true href=#ref>#</a></h2><ul><li><a href=https://stackoverflow.com/questions/18024672/what-registers-are-preserved-through-a-linux-x86-64-function-call>what registers are preserved through a linux x86_64 function call</a></li><li><a href=https://stackoverflow.com/questions/56905811/what-does-the-endbr64-instruction-actually-do>what does the endbr64 instruction actually do</a></li><li><a href=https://gcc.gnu.org/onlinedocs/gcc/Variable-Length.html>gcc VLA</a></li><li><a href=https://www.felixcloutier.com/x86/>x86 and amd64 instruction reference</a></li><li><a href=https://stackoverflow.com/questions/56565510/x86-what-does-movsxd-rdx-edx-instruction-mean>x86 what does movsxd rdx edx instruction mean</a></li><li><a href=https://people.kth.se/~dbro/x86-64-ref-sheet.pdf>x86-64 reference sheet.pdf</a></li><li><a href=https://stackoverflow.com/questions/14267081/difference-between-je-jne-and-jz-jnz>difference between je jne and jz jnz</a></li><li><a href=https://stackoverflow.com/questions/10325713/why-does-this-memory-address-fs0x28-fs0x28-have-a-random-value>why does this memory address fs0x28 fs0x28 have a random value</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://jiaoshijie.github.io/tags/c/>C</a></li></ul><nav class=paginav><a class=prev href=https://jiaoshijie.github.io/posts/variation_of_parameters/><span class=title>«</span><br><span>常数变易法(微分方程求解)</span>
</a><a class=next href=https://jiaoshijie.github.io/posts/reading_linux_source_code_about_lib_list_sort_c/><span class=title>»</span><br><span>阅读 Linux 核心源代码 lib/list_sort.c</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share C 语言函数调用和VLA和alloca栈的变化探讨 on x" href="https://x.com/intent/tweet/?text=C%20%e8%af%ad%e8%a8%80%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%92%8cVLA%e5%92%8calloca%e6%a0%88%e7%9a%84%e5%8f%98%e5%8c%96%e6%8e%a2%e8%ae%a8&amp;url=https%3a%2f%2fjiaoshijie.github.io%2fposts%2ffunction_call_and_vla_and_alloca%2f&amp;hashtags=c"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share C 语言函数调用和VLA和alloca栈的变化探讨 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fjiaoshijie.github.io%2fposts%2ffunction_call_and_vla_and_alloca%2f&amp;title=C%20%e8%af%ad%e8%a8%80%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%92%8cVLA%e5%92%8calloca%e6%a0%88%e7%9a%84%e5%8f%98%e5%8c%96%e6%8e%a2%e8%ae%a8&amp;summary=C%20%e8%af%ad%e8%a8%80%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%92%8cVLA%e5%92%8calloca%e6%a0%88%e7%9a%84%e5%8f%98%e5%8c%96%e6%8e%a2%e8%ae%a8&amp;source=https%3a%2f%2fjiaoshijie.github.io%2fposts%2ffunction_call_and_vla_and_alloca%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share C 语言函数调用和VLA和alloca栈的变化探讨 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fjiaoshijie.github.io%2fposts%2ffunction_call_and_vla_and_alloca%2f&title=C%20%e8%af%ad%e8%a8%80%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%92%8cVLA%e5%92%8calloca%e6%a0%88%e7%9a%84%e5%8f%98%e5%8c%96%e6%8e%a2%e8%ae%a8"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share C 语言函数调用和VLA和alloca栈的变化探讨 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjiaoshijie.github.io%2fposts%2ffunction_call_and_vla_and_alloca%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share C 语言函数调用和VLA和alloca栈的变化探讨 on whatsapp" href="https://api.whatsapp.com/send?text=C%20%e8%af%ad%e8%a8%80%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%92%8cVLA%e5%92%8calloca%e6%a0%88%e7%9a%84%e5%8f%98%e5%8c%96%e6%8e%a2%e8%ae%a8%20-%20https%3a%2f%2fjiaoshijie.github.io%2fposts%2ffunction_call_and_vla_and_alloca%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share C 语言函数调用和VLA和alloca栈的变化探讨 on telegram" href="https://telegram.me/share/url?text=C%20%e8%af%ad%e8%a8%80%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%92%8cVLA%e5%92%8calloca%e6%a0%88%e7%9a%84%e5%8f%98%e5%8c%96%e6%8e%a2%e8%ae%a8&amp;url=https%3a%2f%2fjiaoshijie.github.io%2fposts%2ffunction_call_and_vla_and_alloca%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share C 语言函数调用和VLA和alloca栈的变化探讨 on ycombinator" href="https://news.ycombinator.com/submitlink?t=C%20%e8%af%ad%e8%a8%80%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e5%92%8cVLA%e5%92%8calloca%e6%a0%88%e7%9a%84%e5%8f%98%e5%8c%96%e6%8e%a2%e8%ae%a8&u=https%3a%2f%2fjiaoshijie.github.io%2fposts%2ffunction_call_and_vla_and_alloca%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://jiaoshijie.github.io/>Jsj's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>